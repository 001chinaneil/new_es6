"use strict";Vue.component("zone-list",{props:["hostMap","currentZone","switchZone","selectedHost"],template:'<div class="uphosts-list"><ul><li v-for="item in hostMap" :class="{on: item.zone == currentZone}" @click="switchZone(item.zone)">{{item.zoneZh}}</li></ul><ul><li v-for="item in hostMap" :class="{on: item.zone == currentZone}"><label v-for="uphost in item.uphosts"><input type="radio" v-model="selectedHost.host" :value="uphost"/>{{uphost}}</label></li></ul></div>'}),Vue.component("upload-performance",{props:["per","warning"],template:'<div class="up-performance"><div class="per-title">上传耗时：<span class="warning" v-if="warning">您好，请使用谷歌、IE9+等高级浏览器获取更详细的数据！</span></div><table><tr><th>类型</th><th>耗时 / ms</th></tr><tr v-if="per.redirect != undefined"><td>重定向：</td><td>{{per.redirect | tofixed(2)}}</td></tr><tr v-if="per.domainLookup != undefined"><td>DNS 查询：</td><td>{{per.domainLookup | tofixed(2)}}</td></tr><tr v-if="per.connect != undefined"><td>建立连接：</td><td>{{per.connect | tofixed(2)}}</td></tr><tr v-if="per.request != undefined"><td>发送数据：</td><td>{{per.request | tofixed(2)}}</td></tr><tr v-if="per.response != undefined"><td>接收响应：</td><td>{{per.response | tofixed(2)}}</td></tr><tr v-if="per.duration != undefined"><td>总耗时：</td><td>{{per.duration | tofixed(2)}}</td></tr></table></div>'}),Vue.component("up-headers",{props:["headers"],template:'<div class="up-headers"><div class="per-title">响应头：</div><table><tr><th>类型</th><th>值</th></tr><tr v-for="header in headers"><td>{{header.key}}</td><td>{{header.val}}</td></tr></table></div>'}),Vue.filter("tofixed",function(e,t){return e.toFixed(t)});var app=new Vue({el:"#app",data:{currentZone:"z0",selectedHost:{host:""},currentToken:"",loadMessage:"",hostMap:[{zone:"z0",zoneZh:"华东",token:"xozWSPMxkMjIVoHg2JyXq4-7-oJaEADLOKHVR0vU:ImkQNYuzXd7mj_MJ-Ez3f0ojFhs=:eyJzY29wZSI6Impzc2RrOmEuanBnIiwiZGVhZGxpbmUiOjIxMTQzODA4MDAsImZzaXplTWluIjo4MDAwMDAsImZzaXplTGltaXQiOjEwMDAwMDB9",uphosts:["http://up.qiniu.com","http://upload.qiniu.com","https://up.qbox.me","https://upload.qbox.me"]},{zone:"z1",zoneZh:"华北",token:"xozWSPMxkMjIVoHg2JyXq4-7-oJaEADLOKHVR0vU:mU26SwShCB0I-B1yCsO9-3bK82g=:eyJzY29wZSI6Impzc2RrLXoxOmEuanBnIiwiZGVhZGxpbmUiOjIxMTQzODA4MDAsImZzaXplTWluIjo4MDAwMDAsImZzaXplTGltaXQiOjEwMDAwMDB9",uphosts:["http://up-z1.qiniu.com","http://upload-z1.qiniu.com","https://up-z1.qbox.me","https://upload-z1.qbox.me"]},{zone:"z2",zoneZh:"华南",token:"xozWSPMxkMjIVoHg2JyXq4-7-oJaEADLOKHVR0vU:iEkyIA0yoFKYS-SAihuyR3jPo50=:eyJzY29wZSI6Impzc2RrLXoyOmEuanBnIiwiZGVhZGxpbmUiOjIxMTQzODA4MDAsImZzaXplTWluIjo4MDAwMDAsImZzaXplTGltaXQiOjEwMDAwMDB9",uphosts:["http://up-z2.qiniu.com","http://upload-z2.qiniu.com","https://up-z2.qbox.me","https://upload-z2.qbox.me"]},{zone:"na0",zoneZh:"北美",token:"xozWSPMxkMjIVoHg2JyXq4-7-oJaEADLOKHVR0vU:4iTbAdFUN_fV0IQdN5vJReR9fx0=:eyJzY29wZSI6Impzc2RrLW5hMDphLmpwZyIsImRlYWRsaW5lIjoyMTE0MzgwODAwLCJmc2l6ZU1pbiI6ODAwMDAwLCJmc2l6ZUxpbWl0IjoxMDAwMDAwfQ==",uphosts:["http://up-na0.qiniu.com","http://upload-na0.qiniu.com","https://up-na0.qbox.me","https://upload-na0.qbox.me"]}],isPerformanceSupported:!0,performance:null,headers:null,timetags:{},totalBytes:0},methods:{renderHtml:function(){},post:function(e){var t=new XMLHttpRequest;if(t.open("POST",e.url,!0),t.setRequestHeader("X-Qiniu-Performance","true"),e.headers)for(var o in e.headers)t.setRequestHeader(o,e.headers[o]);t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.success&&e.success(t):e.error&&e.error(t.responseText),e.finally&&e.finally(t.status,t))},t.upload.onprogress=e.progress,this.timetags.beginAjax=+new Date,t.send(e.data)},uploadTest:function(){if(this.selectedHost.host){this.resetResult();var o=this;httpPerformance.clear(),this.post({url:this.selectedHost.host,data:this.mockDate(),progress:function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;o.loadMessage="模拟数据上传："+e.loaded+" / "+e.total+" bytes  完成："+t.toFixed(2)+"%",100===t&&(o.timetags.afterUpload=+new Date,o.totalBytes=e.total)}},success:function(e){o.formateHeader(e.getAllResponseHeaders())},error:function(e){o.loadMessage="上传失败："+e},finally:function(e,t){o.timetags.afterAjax=+new Date,o.getPerformance(),o.formateLog(e,t)}})}},mockDate:function(e){var t=new FormData(document.getElementById("testform"));return t.append("file",this.dataURLtoBlob(this.randomBase64(e))),t.append("token",this.currentToken),t},randomBase64:function(){for(var e="data:image/jpeg;base64,",t=parseInt(230001*Math.random()+11e5,10);e.length<t;)e+=.5<Math.random?"/9j/4AAQSkZJRgABAQAASABIAAD/4Q":"/9j/4AAQSkZJRgABAQAASABIAAD/4W";return e},dataURLtoBlob:function(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],s=atob(t[1]),a=s.length,r=new Uint8Array(a);a--;)r[a]=s.charCodeAt(a);return new Blob([r],{type:o})},resetResult:function(){for(var e=0;e<this.hostMap.length;e++)if(this.hostMap[e].zone===this.currentZone){this.currentToken=this.hostMap[e].token;break}this.performance=null,this.headers=null,this.timetags={}},switchZone:function(e){this.currentZone=e,this.selectedHost.host=""},getPerformance:function(){if(this.isPerformanceSupported){var e=httpPerformance.getByName(this.selectedHost.host+"/");2==e.length&&(e[1].redirect=e[0].redirect,e[1].domainLookup=e[0].domainLookup,e[1].connect=e[0].connect),this.performance=e[1]||e[0]}else this.performance={request:this.timetags.afterUpload-this.timetags.beginAjax,response:this.timetags.afterAjax-this.timetags.afterUpload,duration:this.timetags.afterAjax-this.timetags.beginAjax}},formateHeader:function(e){var s=[];e.match(/.+/gm).map(function(e){var t=e.indexOf(":"),o={key:e.substr(0,t),val:e.substr(t+1)};s.push(o)}),this.headers=s},formateLog:function(e,t){headers=t.getAllResponseHeaders();var o=headers.match(/X-Reqid:\s*(\w+)/);o&&2===o.length&&(o=o[1]);var s=this.selectedHost.host,a=80;s&&(-1<s.indexOf("https")&&(a=443),s=s.split("//")[1]),remote_ip=headers.match(/X-Forwarded-For:[^,]+,\s*([^,]+)/),remote_ip&&2===remote_ip.length&&(remote_ip=remote_ip[1]);var r=this.performance.duration.toFixed(2),n=this.timetags.beginAjax.toString().slice(0,-3),i=this.totalBytes,p=[e,o,s,remote_ip,a,r,n,i,"jsperf"];this.sendLog(p)},sendLog:function(e){this.post({url:"https://uplog.qbox.me/log/2",data:e.join(","),headers:{Authorization:"UpToken xozWSPMxkMjIVoHg2JyXq4-7-oJaEADLOKHVR0vU:iEkyIA0yoFKYS-SAihuyR3jPo50=:eyJzY29wZSI6Impzc2RrLXoyOmEuanBnIiwiZGVhZGxpbmUiOjIxMTQzODA4MDAsImZzaXplTWluIjo4MDAwMDAsImZzaXplTGltaXQiOjEwMDAwMDB9"}})}},created:function(){this.isPerformanceSupported=!(!window.performance||!window.performance.getEntries)}});