"use strict";function FileProgress(e,r){if(this.fileProgressID=e.id,this.file=e,this.opacity=100,this.height=0,this.fileProgressWrapper=$("#"+this.fileProgressID),this.fileProgressWrapper.length)this.reset();else{this.fileProgressWrapper=$("<tr></tr>");var s=this.fileProgressWrapper;s.attr("id",this.fileProgressID).addClass("progressContainer");var t=$("<td/>");t.addClass("progressName").text(e.name);var a=plupload.formatSize(e.size).toUpperCase(),i=$("<td/>");i.addClass("progressFileSize").text(a);var o=$("<td/>"),p=$("<div/>");p.addClass("info");var n=$("<div/>");n.addClass("progress progress-striped");var d=$("<div/>");d.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var l=$("<span class=sr-only />");l.text(a);var f=$("<a href=javascript:; />");f.show().addClass("progressCancel").text("×"),d.append(l),n.append(d),p.append(n),p.append(f);var g=$('<div class="status text-center"/>');p.append(g),o.append(p),s.append(t),s.append(i),s.append(o),$("#"+r).append(s)}this.height=this.fileProgressWrapper.offset().top,this.setTimer(null)}FileProgress.prototype.setTimer=function(e){this.fileProgressWrapper.FP_TIMER=e},FileProgress.prototype.getTimer=function(e){return this.fileProgressWrapper.FP_TIMER||null},FileProgress.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer"),this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text(""),this.appear()},FileProgress.prototype.setChunkProgess=function(e){var r=Math.ceil(this.file.size/e);if(1===r)return!1;$('<button class="btn btn-default">查看分块上传进度</button>');for(var s=$('<tr class="chunk-status-tr"><td colspan=3></td></tr>'),t=$("<div/>"),a=1;a<=r;a++){var i=$('<div class="col-md-2"/>'),o=$('<div class="progress progress-striped"></div'),p=$("<div/>");p.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+a).text("");var n=$("<span/>");n.addClass("chunk-status").text(),o.append(p),o.append(n),i.append(o),t.append(i)}this.fileProgressWrapper.find("td:eq(2) .btn-default").length,s.hide().find("td").append(t),s.insertAfter(this.fileProgressWrapper)},FileProgress.prototype.setProgress=function(e,r,s){this.fileProgressWrapper.attr("class","progressContainer green");var t=this.file,a=t.loaded,i=plupload.formatSize(a).toUpperCase(),o=plupload.formatSize(r).toUpperCase(),p=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");if("取消上传"!==this.fileProgressWrapper.find(".status").text()){if(this.fileProgressWrapper.find(".status").text("已上传: "+i+" 上传速度： "+o+"/s"),e=parseInt(e,10),t.status!==plupload.DONE&&100===e&&(e=99),p.attr("aria-valuenow",e).css("width",e+"%"),s){var n=Math.ceil(t.size/s);if(1===n)return!1;for(var d,l,f=Math.ceil(a/s),g=0;g<f;g++)(d=$("#"+t.id+"_"+g)).width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100),l="块"+g+"上传进度100%",d.next().html(l);var h,c=$("#"+t.id+"_"+f);if(f<n)a%s?h=(a%s/s*100).toFixed(2):(h=100,c.removeClass().addClass("alert-success"));else{var u=t.size-s*(n-1);(t.size-a)%u?h=(a%s/u*100).toFixed(2):(h=100,c.removeClass().addClass("alert-success"))}c.width(h+"%"),c.attr("aria-valuenow",h),l="块"+f+"上传进度"+h+"%",c.next().html(l)}this.appear()}},FileProgress.prototype.setComplete=function(e,r){var s,t=this.fileProgressWrapper.find("td:eq(2)"),a=t.find(".progress"),i=$.parseJSON(r);if($("#audio_url").val(i.key),i.url)s=i.url,str="<div><strong>Link:</strong><a href="+i.url+" target='_blank' > "+i.url+"</a></div><div class=hash><strong>Hash:</strong>"+i.hash+"</div>";else{var o=e.getOption("domain");s=o+encodeURI(i.key);var p=o+i.key;str="<div><strong>Link:</strong><a href="+s+" target='_blank' > "+p+"</a></div><div class=hash><strong>Hash:</strong>"+i.hash+"</div>"}a.html(str).removeClass().next().next(".status").hide(),t.find(".progressCancel").hide();var n=this.fileProgressWrapper.find(".progressName"),d=function(e){var r,s=["png","jpg","jpeg","gif","bmp"],t=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!t.test(e))return!1;r=t.exec(e)[1].toLowerCase();for(var a=0,i=s.length;a<i;a++)if(r===s[a])return!0;return!1}(s),l=$('<div class="Wrapper"/>'),f=$('<div class="imgWrapper col-md-3"/>'),g=$('<a class="linkWrapper" target="_blank"/>');if(n.append(l),d){f.append(g);var h=new Image;/imageView/.test(s)||(s+="?imageView2/1/w/100/h/100"),$(h).attr("src",s);$(h).on("load",function(){showImg.attr("src",s),g.attr("href",s).attr("title","查看原图");var e=$('<div class="infoWrapper col-md-6"></div>'),r=$('<a class="fopLink"/>');e.append(r),r.on("click",function(){var e=$(this).data("key"),r=parseInt($(this).parents(".Wrapper").find(".origin-height").text(),10);r=r>$(window).height()-340?parseInt($(window).height()-340,10):parseInt(r,10)||300;var s=Qiniu.pipeline([],e);return $("#myModal-img").on("hide.bs.modal",function(){$("#myModal-img").find(".btn-default").removeClass("disabled"),$("#myModal-img").find(".text-warning").hide()}).on("show.bs.modal",function(){$("#myModal-img").find(".imageView").find("a:eq(0)").addClass("disabled"),$("#myModal-img").find(".watermark").find("a:eq(3)").addClass("disabled"),$("#myModal-img").find(".text-warning").hide()}),function(e,r,s){$("#myModal-img").modal();var t=$("#myModal-img").find(".modal-body");s<=300&&$("#myModal-img").find(".text-warning").show();var a=new Image;a.onload=function(){t.find("img").attr("src",e).data("key",r).data("h",s),t.find(".modal-body-wrapper").find("a").attr("href",e)},a.src=e}(s,e,r),!1});Qiniu.detectIEVersion()}).on("error",function(){showImg.attr("src","default.png"),l.addClass("default")})}else l.addClass("default")},FileProgress.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning"),this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide(),this.fileProgressWrapper.find("button").hide(),this.fileProgressWrapper.next(".chunk-status-tr").hide()},FileProgress.prototype.setCancelled=function(e){var r="progressContainer";e||(r+=" red"),this.fileProgressWrapper.attr("class",r),this.fileProgressWrapper.find("td .progress").remove(),this.fileProgressWrapper.find("td:eq(2) .btn-default").hide(),this.fileProgressWrapper.find("td:eq(2) .progressCancel").hide()},FileProgress.prototype.setStatus=function(e,r){r||this.fileProgressWrapper.find(".status").text(e).attr("class","status text-left")},FileProgress.prototype.bindUploadCancel=function(e){var r=this;e&&r.fileProgressWrapper.find("td:eq(2) .progressCancel").on("click",function(){r.setCancelled(!1),r.setStatus("取消上传"),r.fileProgressWrapper.find(".status").css("left","0"),$(".uploadAudioBoxShade").hide(),e.removeFile(r.file)})},FileProgress.prototype.appear=function(){if(null!==this.getTimer()&&(clearTimeout(this.getTimer()),this.setTimer(null)),this.fileProgressWrapper[0].filters)try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(e){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}else this.fileProgressWrapper.css("opacity",1);this.fileProgressWrapper.css("height",""),this.height=this.fileProgressWrapper.offset().top,this.opacity=100,this.fileProgressWrapper.show()};